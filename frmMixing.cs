using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using DevExpress.XtraGrid.Views.Grid;
using ScaleApp.Common;

namespace ScaleApp
{
    public partial class frmMixing : Form
    {
        public frmMixing()
        {
            InitializeComponent();
            // This line of code is generated by Data Source Configuration Wizard
            // Fill a SqlDataSource asynchronously
            sqlDataSource1.FillAsync();
        }

        private void frmMixing_Load(object sender, EventArgs e)
        {               

            txtWeightRM.Text = "0";
            txtWeightRecycled.Text = "0";
            txtTotal.Text = "0";

            loadComboBoxOperator();
            loadComboBoxStep();
            loadComboBoxProduct();
            loadComboBoxMaterial();
            loadComboBoxRecycle();            
            loadGridView1();
            Start_Timer();
        }        

        private void cmbProduct_SelectedIndexChanged(object sender, EventArgs e)
        {
            
            if (cmbProduct.SelectedItem.IsNull())
            {
                loadComboBoxColor();
            }
            else
            {
                loadColorsByProduct(cmbProduct.SelectedValue.ToString());                
            }
            qrMixLotID.Text = generateTextQRCode();
        }

        private void btnSendToMaterial_Click(object sender, EventArgs e)
        {
            txtWeightRM.Text = txtScaleWeight.Text;
        }

        private void btnSendToRecycled_Click(object sender, EventArgs e)
        {
            txtWeightRecycled.Text = txtScaleWeight.Text;
        }

        private void btnSave_Click(object sender, EventArgs e)
        {
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);
            SqlCommand cmd = new SqlCommand("sp_createMixRaw", conn);            
            cmd.CommandType = CommandType.StoredProcedure;

            cmd.Parameters.AddWithValue("@shiftID", cmbShift.SelectedItem);
            cmd.Parameters.AddWithValue("@operatorCode", cmbOperator.SelectedValue);
            cmd.Parameters.AddWithValue("@productCode", cmbProduct.SelectedValue);
            cmd.Parameters.AddWithValue("@materialCode", cmbMaterial.SelectedValue);
            cmd.Parameters.AddWithValue("@colorCode", cmbColor.SelectedValue);
            cmd.Parameters.AddWithValue("@stepId", cmbStep.SelectedValue);
            cmd.Parameters.AddWithValue("@weightRecycle", txtWeightRecycled.Text);
            cmd.Parameters.AddWithValue("@weightMaterial", txtWeightRM.Text);
            cmd.Parameters.AddWithValue("@totalMaterial", txtTotal.Text);
            cmd.Parameters.AddWithValue("@machineID", txtMachine.Text);
            cmd.Parameters.AddWithValue("@crushRawId", cmbRecycled.Text);
            cmd.Parameters.AddWithValue("@qrCode", qrMixLotID.Text);

            conn.Open();

            int i = cmd.ExecuteNonQuery();

            ScaleApp.Common.DataOperation.disconnect();

            if (i != 0)
            {
                MessageBox.Show(i + "Data Saved");
            }

        }

        private void cmbOperator_SelectedIndexChanged(object sender, EventArgs e)
        {

        }

        private void cmbOperator_Click(object sender, EventArgs e)
        {

        }

        private void loadComboBoxOperator()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getOperators", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbOperator.DataSource = ds.Tables[0];
                cmbOperator.DisplayMember = "OperatorName";
                cmbOperator.ValueMember = "OperatorCode";
            } catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadComboBoxStep()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getSteps", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbStep.DataSource = ds.Tables[0];
                cmbStep.DisplayMember = "StepName";
                cmbStep.ValueMember = "StepCode";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadComboBoxProduct()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getProducts", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbProduct.DataSource = ds.Tables[0];
                cmbProduct.DisplayMember = "ProductName";
                cmbProduct.ValueMember = "ProductCode";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadComboBoxColor()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getColors", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbColor.DataSource = ds.Tables[0];
                cmbColor.DisplayMember = "ColorName";
                cmbColor.ValueMember = "ColorCode";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadComboBoxMaterial()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getMaterials", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbMaterial.DataSource = ds.Tables[0];
                cmbMaterial.DisplayMember = "MaterialName";
                cmbMaterial.ValueMember = "MaterialCode";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadComboBoxRecycle()
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getCrushRaws", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                cmbRecycled.DataSource = ds.Tables[0];
                cmbRecycled.DisplayMember = "CrushRawId";
                cmbRecycled.ValueMember = "CrushRawId";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void loadColorsByProduct(string productId)
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();            
            SqlConnection conn = new SqlConnection(connStr);
            SqlDataAdapter SqlDa = new SqlDataAdapter();
            SqlCommand sqlcmd = new SqlCommand("sp_getColorsProduct", conn);
            try
            {
                sqlcmd.CommandType = CommandType.StoredProcedure;
                sqlcmd.Parameters.AddWithValue("@ProductId", productId);
                SqlDa.SelectCommand = sqlcmd;

                SqlDa.Fill(ds);                

                cmbColor.DataSource = ds.Tables[0];
                cmbColor.DisplayMember = "ColorCode";
                cmbColor.ValueMember = "ColorCode";
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();

        }

        private string getTotalWeight()
        {
            Double weightRM = 0;
            Double weightRe = 0;
            Double weightTotal = 0;
                
            if (String.IsNullOrEmpty(txtWeightRM.Text))
            {
                weightRM = 0;
            }
            else
            {
                weightRM = double.Parse(txtWeightRM.Text);
            }

            if (String.IsNullOrEmpty(txtWeightRecycled.Text))
            {
                weightRe = 0;
            }
            else
            {
                weightRe = double.Parse(txtWeightRecycled.Text);
            }            
            weightTotal = weightRM + weightRe;
            return weightTotal.ToString();
        }

        private void txtWeightRM_TextChanged(object sender, EventArgs e)
        {            
            txtTotal.Text = getTotalWeight();
        }

        private void txtWeightRecycled_TextChanged(object sender, EventArgs e)
        {            
            txtTotal.Text = getTotalWeight();
        }

        private string generateTextQRCode()
        {
            String qrCodeText = "";
            qrCodeText = ScaleApp.Common.mFunction.GenerateTextQRCode("MI", DateTime.Today);
            return qrCodeText;
        }

        private void loadGridView1()
        {   
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);

            try
            {
                using (SqlDataAdapter SqlDa = new SqlDataAdapter("sp_getMixRaws", conn))
                {
                    SqlDa.SelectCommand.CommandType = CommandType.StoredProcedure;
                    SqlDa.Fill(ds);
                }

                gridView1.DataSource = ds.Tables[0];
                //Select only one row
                gridView1.MultiSelect = false;
                //Change name of Columns
                gridView1.Columns[0].HeaderText = "ID";                
                gridView1.Columns[1].HeaderText = "Shift";
                gridView1.Columns[2].HeaderText = "Operator";
                gridView1.Columns[3].HeaderText = "Item";
                gridView1.Columns[4].HeaderText = "Material";
                gridView1.Columns[5].HeaderText = "Color";
                gridView1.Columns[6].HeaderText = "Step";
                gridView1.Columns[8].HeaderText = "Weight RM";
                gridView1.Columns[9].HeaderText = "Weight Re";
                gridView1.Columns[10].HeaderText = "Total";
                gridView1.Columns[11].HeaderText = "Machine";
                gridView1.Columns[12].HeaderText = "Mix Lot";
                gridView1.Columns[14].HeaderText = "Date";
                gridView1.Columns[15].HeaderText = "Recycled Lot";

                gridView1.Columns[0].Width = 40;
                gridView1.Columns[1].Width = 40;
                gridView1.Columns[2].Width = 80;
                gridView1.Columns[3].Width = 120;
                gridView1.Columns[4].Width = 120;
                gridView1.Columns[5].Width = 100;
                gridView1.Columns[6].Width = 40;
                gridView1.Columns[8].Width = 80;
                gridView1.Columns[9].Width = 80;
                gridView1.Columns[10].Width = 80;
                gridView1.Columns[11].Width = 80;
                gridView1.Columns[12].Width = 120;
                gridView1.Columns[14].Width = 100;
                gridView1.Columns[15].Width = 120;
                //Hide columns
                gridView1.Columns[7].Visible = false; //Hide column name WeightMix
                gridView1.Columns[13].Visible = false; //Hide column CreatedBy
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }        

        private void loadMixRaw(int mixId)
        {
            DataSet ds = new DataSet();
            String connStr = ScaleApp.Common.DataOperation.GetConnectionString();
            SqlConnection conn = new SqlConnection(connStr);
            SqlDataAdapter SqlDa = new SqlDataAdapter();
            SqlCommand sqlcmd = new SqlCommand("sp_getMixRaw", conn);

            try
            {
                sqlcmd.CommandType = CommandType.StoredProcedure;
                sqlcmd.Parameters.AddWithValue("@mixRawId", mixId);
                SqlDa.SelectCommand = sqlcmd;
                SqlDa.Fill(ds);
                
                cmbShift.SelectedItem = ds.Tables[0].Rows[0][1]; //Get ShiftID
                cmbOperator.SelectedValue = ds.Tables[0].Rows[0][2]; //Get Operator
                cmbProduct.SelectedValue = ds.Tables[0].Rows[0][3]; //Get Item
                cmbMaterial.SelectedValue = ds.Tables[0].Rows[0][4]; //Get Material
                cmbColor.SelectedValue = ds.Tables[0].Rows[0][5]; //Get Color
                cmbStep.SelectedValue = ds.Tables[0].Rows[0][6]; //Get Step
                txtWeightRM.Text = ds.Tables[0].Rows[0][8].ToString(); //Get Weight RM
                txtWeightRecycled.Text = ds.Tables[0].Rows[0][9].ToString(); //Get Weight Recycled
                txtTotal.Text = ds.Tables[0].Rows[0][10].ToString(); //Get Total
                txtMachine.Text = ds.Tables[0].Rows[0][11].ToString(); //Get Machine
                qrMixLotID.Text = ds.Tables[0].Rows[0][12].ToString(); //Get Mix Lot ID
                cmbRecycled.SelectedValue = ds.Tables[0].Rows[0][15]; //Get Recycled Lot ID
                txtMixDate.Text = ds.Tables[0].Rows[0][14].ToString(); //Get Mix Lot Date
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            ScaleApp.Common.DataOperation.disconnect();
        }

        private void Start_Timer()
        {
            timer1 = new System.Windows.Forms.Timer();
            timer1.Interval = 1000;
            timer1.Tick += new EventHandler(Timer1_Tick);
            timer1.Enabled = true;
        }

        private void Timer1_Tick(object sender, EventArgs e)
        {
            lblDateTime.Text = DateTime.Now.ToString();
        }

        private void button5_Click(object sender, EventArgs e)
        {
            //string labelType = cmbLabelType.SelectedValue.ToString();

            //switch (labelType)
            //{
            //    case "Mixed":
            //    case "Runner":
            //    case "Defect":
            //    case "BlackDot":
            //    case "Contaminated":
            //    default:
            //}

            frmReportMixed report = new frmReportMixed();
            report.ShowDialog();
        }        

        private void gridView1_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (gridView1.CurrentCell.RowIndex != -1)
            {
                //do you staff.
                int rowindex = gridView1.CurrentCell.RowIndex;
                int columnindex = gridView1.CurrentCell.ColumnIndex;

                txtMixID.Text = gridView1.Rows[rowindex].Cells[0].Value.ToString();
                loadMixRaw(int.Parse(txtMixID.Text.ToString()));
            }
        }
    }
}
